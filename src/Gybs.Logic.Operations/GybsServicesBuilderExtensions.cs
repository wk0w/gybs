using Gybs.DependencyInjection;
using Gybs.Internal;
using Gybs.Logic.Operations.Factory;
using Gybs.Logic.Operations.Factory.Internal;
using Gybs.Logic.Operations.ServiceProvider;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.DependencyInjection.Extensions;
using System;
using System.Reflection;

namespace Gybs.Logic.Operations;

/// <summary>
/// <see cref="GybsServicesBuilder"/> extensions.
/// </summary>
public static class GybsServicesBuilderExtensions
{
    /// <summary>
    /// Adds a <see cref="IOperationBus"/> which handles operations by resolving a handler from service provider.
    /// </summary>
    /// <param name="servicesBuilder">The builder.</param>
    /// <returns>The builder.</returns>
    public static GybsServicesBuilder AddServiceProviderOperationBus(this GybsServicesBuilder servicesBuilder)
    {
        ((IInfrastructure<IServiceCollection>)servicesBuilder).Instance
            .TryAddScoped<IOperationBus, ServiceProviderOperationBus>();
        return servicesBuilder;
    }

    /// <summary>
    /// Adds a <see cref="IOperationFactory"/> which allows to create and handle operations via <see cref="IOperationBus"/>.
    /// </summary>
    /// <param name="servicesBuilder">The builder.</param>
    /// <returns>The builder.</returns>
    public static GybsServicesBuilder AddOperationFactory(this GybsServicesBuilder servicesBuilder)
    {
        ((IInfrastructure<IServiceCollection>)servicesBuilder).Instance
            .TryAddScoped<IOperationFactory, OperationFactory>();
        return servicesBuilder;
    }

    /// <summary>
    /// Adds all operation initializers from the assembly which are used by factory to initialize operations.
    /// </summary>
    /// <param name="servicesBuilder">The builder.</param>
    /// <param name="assembly">The assembly. If not provided, <see cref="Assembly.GetCallingAssembly"/> is used.</param>
    /// <returns>The builder.</returns>
    [Obsolete("Given the possibility of multiple ServiceAttribute instances with different groups defined, usage of this method is discouraged.")]
    public static GybsServicesBuilder AddOperationInitializersForFactory(this GybsServicesBuilder servicesBuilder, Assembly? assembly = null)
    {
        ((IInfrastructure<IServiceCollection>)servicesBuilder).Instance
            .AddTypesImplementingInterfaceFromAssembly(typeof(IOperationInitializer), assembly ?? Assembly.GetCallingAssembly(), ServiceLifetime.Scoped);
        return servicesBuilder;
    }

    /// <summary>
    /// Adds all operation handlers from the assembly.
    /// </summary>
    /// <param name="servicesBuilder">The builder.</param>
    /// <param name="assembly">The assembly. If not provided, <see cref="Assembly.GetCallingAssembly"/> is used.</param>
    /// <returns>The builder.</returns>
    [Obsolete("Given the possibility of multiple ServiceAttribute instances with different groups defined, usage of this method is discouraged.")]
    public static GybsServicesBuilder AddOperationHandlers(this GybsServicesBuilder servicesBuilder, Assembly? assembly = null)
    {
        var serviceCollection = ((IInfrastructure<IServiceCollection>)servicesBuilder).Instance;
        serviceCollection.AddTypesImplementingInterfaceFromAssembly(typeof(IOperationHandler<>), assembly ?? Assembly.GetCallingAssembly(), ServiceLifetime.Transient);
        serviceCollection.AddTypesImplementingInterfaceFromAssembly(typeof(IOperationHandler<,>), assembly ?? Assembly.GetCallingAssembly(), ServiceLifetime.Transient);

        return servicesBuilder;
    }
}
